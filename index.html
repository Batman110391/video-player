<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="referrer" content="strict-origin-when-cross-origin">
  <title>YouTube Video</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      background: #000;
    }
    #player {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 0;
    }
  </style>
</head>
<body>
  <div id="player"></div>
  
  <script>
    // Parse URL parameters
    const urlParams = new URLSearchParams(window.location.search);
    const videoId = urlParams.get('v');
    
    if (!videoId) {
      document.body.innerHTML = '<div style="color: white; padding: 20px; text-align: center;">Error: Missing video ID parameter (?v=VIDEO_ID)</div>';
    }
    
    // Get optional parameters
    const autoplay = urlParams.get('autoplay') === '1' ? 1 : 0;
    const loop = urlParams.get('loop') === '1' ? 1 : 0;
    const mute = urlParams.get('mute') === '1' ? 1 : 0;
    const controls = urlParams.get('controls') === '1' ? 1 : 0;
    
    let player;
    let isPlayerReady = false;
    
    // Carica YouTube IFrame API
    const tag = document.createElement('script');
    tag.src = 'https://www.youtube.com/iframe_api';
    const firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    
    // Callback quando API è pronta
    window.onYouTubeIframeAPIReady = function() {
      console.log('YouTube API Ready');
      
      player = new YT.Player('player', {
        videoId: videoId,
        playerVars: {
          autoplay: autoplay,
          controls: controls,
          loop: loop,
          playlist: loop ? videoId : '',
          mute: mute,
          rel: 0,
          modestbranding: 1,
          playsinline: 1,
          enablejsapi: 1,
          origin: window.location.origin
        },
        events: {
          onReady: onPlayerReady,
          onStateChange: onPlayerStateChange,
          onError: onPlayerError
        }
      });
    };
    
    function onPlayerReady(event) {
      console.log('Player Ready');
      isPlayerReady = true;
      
      // Notifica al parent che il player è pronto
      if (window.parent !== window) {
        window.parent.postMessage(JSON.stringify({
          event: 'onReady',
          info: 'Player is ready'
        }), '*');
      }
      
      // Autoplay se richiesto
      if (autoplay === 1) {
        event.target.playVideo();
      }
    }
    
    function onPlayerStateChange(event) {
      console.log('Player State Changed:', event.data);
      
      // Notifica al parent il cambio di stato
      if (window.parent !== window) {
        window.parent.postMessage(JSON.stringify({
          event: 'onStateChange',
          info: event.data
        }), '*');
      }
      
      // Se video finito e loop non attivo, notifica
      if (event.data === YT.PlayerState.ENDED && loop !== 1) {
        if (window.parent !== window) {
          window.parent.postMessage('ENDED', '*');
        }
      }
    }
    
    function onPlayerError(event) {
      console.error('Player Error:', event.data);
      if (window.parent !== window) {
        window.parent.postMessage(JSON.stringify({
          event: 'onError',
          info: event.data
        }), '*');
      }
    }
    
    // Ascolta messaggi dal parent (React Native WebView)
    window.addEventListener('message', function(event) {
      if (!isPlayerReady || !player) {
        console.log('Player not ready, ignoring command');
        return;
      }
      
      let data;
      try {
        data = typeof event.data === 'string' ? JSON.parse(event.data) : event.data;
      } catch (e) {
        console.log('Cannot parse message:', event.data);
        return;
      }
      
      console.log('Received command:', data);
      
      // Gestisci comandi
      if (data.event === 'command') {
        const func = data.func;
        const args = data.args || [];
        
        switch(func) {
          case 'playVideo':
            console.log('Executing: playVideo');
            player.playVideo();
            break;
          case 'pauseVideo':
            console.log('Executing: pauseVideo');
            player.pauseVideo();
            break;
          case 'stopVideo':
            player.stopVideo();
            break;
          case 'mute':
            player.mute();
            break;
          case 'unMute':
            player.unMute();
            break;
          case 'setVolume':
            if (args[0] !== undefined) {
              player.setVolume(args[0]);
            }
            break;
          case 'seekTo':
            if (args[0] !== undefined) {
              player.seekTo(args[0], true);
            }
            break;
          default:
            console.log('Unknown command:', func);
        }
      }
    });
    
    // Per iOS: ascolta anche messaggi su window direttamente
    if (window.webkit && window.webkit.messageHandlers) {
      console.log('iOS WebKit detected');
    }
  </script>
</body>
</html>
